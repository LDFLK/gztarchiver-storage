name: gztarchiver

on:
  schedule:
    - cron: "0 */1 * * *"  # every 2 hours
  workflow_dispatch:        # allows manual trigger

jobs:
  run-archiver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout storage repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TARGET_REPO_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install archiver package
        run: pip install git+https://github.com/yasandu0505/gztarchiver.git

      - name: Create config.yaml from secret
        run: |
          echo "${{ secrets.GZTARCHIVER_CONFIG }}" > config.yaml

      - name: Run archiver
        run: |
          gztarchiver --year 2010 --month 06 --day 24 --lang en --config config.yaml
          gztarchiver --year 2019 --month 12 --day 31 --lang en --config config.yaml
          rm -rf metadata

      - name: Commit and push doc-archive
        run: |
          git config user.name "yasandu0505"
          git config user.email "yasanduyaka2005@gmail.com"
          git add doc-archive
          git commit -m "ðŸ”„ Auto-update archive - $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin main --force
